}

// Fungsi untuk memuat data dari Google Sheets
async function fetchDataFromSheet() {
try {
// URL Google Sheets yang sudah dipublikasikan
const sheetUrl = 'https://docs.google.com/spreadsheets/d/1WMbp6aWmubH5R0lAtIMMQbKDuzfCmh4qrUCEBxqZK9E/gviz/tq?tqx=out:csv&sheet=part1';
const response = await fetch(sheetUrl);
if (!response.ok) {
throw new Error(`HTTP error! status: ${response.status}`);
}
const csvData = await response.text();

// Parsing CSV dengan fungsi yang lebih andal
const parsedData = parseCSV(csvData);

const headers = parsedData.headers;
const rows = parsedData.data;

// Cari indeks kolom yang benar
const nameIndex = headers.findIndex(header =>
header.toLowerCase().includes('nama') || header.toLowerCase().includes('cs')
);
const errorIndex = headers.findIndex(header =>
header.toLowerCase().includes('total') || header.toLowerCase().includes('kesalahan')
);

// Jika tidak menemukan kolom yang sesuai, gunakan kolom pertama dan kedua
const finalNameIndex = nameIndex !== -1 ? nameIndex : 0;
const finalErrorIndex = errorIndex !== -1 ? errorIndex : 1;

const data = [];
for (let i = 0; i < rows.length; i++) {
const row = rows[i];
if (row.length <= Math.max(finalNameIndex, finalErrorIndex)) continue;

const name = row[finalNameIndex] || 'Tidak Diketahui';
const errors = parseInt(row[finalErrorIndex]) || 0;
data.push({ name, errors });
}

// Simpan data sebelumnya untuk perbandingan
previousData = [...csData];

// Filter CS tertentu yang ingin dihilangkan
csData = data.filter(cs =>
!cs.name.includes("RINAL ABDILLAH NASUTION") &&
!cs.name.includes("ANDI") &&
!cs.name.includes("CHARLIE")
);

renderData();
showNotification('success', 'Data terbaru telah berhasil diambil');
addHistory('Data diperbarui dari Google Sheets');
} catch (error) {
console.error('Error fetching data:', error);
showNotification('error', 'Gagal memuat data: ' + error.message);
addHistory('Gagal memuat data: ' + error.message);

// Jika tidak ada data sebelumnya, tampilkan pesan error
if (csData.length === 0) {
document.getElementById('totalErrors').textContent = 'Error';
document.getElementById('totalCS').textContent = 'Error';
document.getElementById('averageErrors').textContent = 'Error';
document.getElementById('criticalCount').textContent = 'Error';
document.getElementById('csCount').textContent = 'Error';
}
}
}

// Fungsi untuk merender data
function renderData() {
// Urutkan data berdasarkan jumlah kesalahan (dari terkecil ke terbesar)
const sortedData = [...csData].sort((a, b) => a.errors - b.errors);

// Hitung statistik
const totalErrors = sortedData.reduce((sum, cs) => sum + cs.errors, 0);
const totalCS = sortedData.length;
const averageErrors = totalCS > 0 ? (totalErrors / totalCS).toFixed(1) : 0;
const criticalCount = sortedData.filter(cs => cs.errors > 25).length;

// Update statistik
document.getElementById('totalErrors').textContent = totalErrors;
document.getElementById('totalCS').textContent = totalCS;
document.getElementById('averageErrors').textContent = averageErrors;
document.getElementById('criticalCount').textContent = criticalCount;
document.getElementById('csCount').textContent = `${totalCS} CS`;

// Update waktu terakhir
document.getElementById('lastUpdated').innerHTML = `<i class="fas fa-clock me-1"></i>Terakhir diperbarui: ${new Date().toLocaleTimeString('id-ID')}`;

// Render top 3
const top3 = sortedData.slice(0, 3);
const top3Html = top3.map((cs, index) => {
const status = getStatus(cs.errors);
const shortName = cs.name.split(' ')[0];
return `
<div class="col-md-4 mb-3">
<div class="winner-card winner-card-${index+1} text-center p-3">
<div class="winner-badge">${index === 0 ? 'ðŸ¥‡' : index === 1 ? 'ðŸ¥ˆ' : 'ðŸ¥‰'}</div>
<h4>Juara ${index+1}</h4>
<div class="cs-avatar mx-auto mb-2">${shortName.charAt(0)}</div>
<h5>${shortName}</h5>
<p class="mb-1 text-truncate">${cs.name.split(' ').slice(1).join(' ')}</p>
<div class="stats-number ${cs.errors === 0 ? 'text-success' : 'text-primary'}">${cs.errors}</div>
<div class="stats-label">Kesalahan</div>
<span class="status-badge ${status.class}">${status.text}</span>
</div>
</div>
`;
}).join('');
document.getElementById('top3Container').innerHTML = top3Html;

// Render tabel
const tableHtml = sortedData.map((cs, index) => {
const status = getStatus(cs.errors);
let rankBadge = `<div class="rank-badge">${index+1}</div>`;
if (index === 0) rankBadge = `<div class="rank-badge rank-1">1</div>`;
else if (index === 1) rankBadge = `<div class="rank-badge rank-2">2</div>`;
else if (index === 2) rankBadge = `<div class="rank-badge rank-3">3</div>`;
return `
<tr>
<td>${rankBadge}</td>
<td>
<div class="d-flex align-items-center">
<div class="cs-avatar">${cs.name.charAt(0)}</div>
<div class="cs-name-clickable" onclick="showCSDetail(${JSON.stringify(cs).replace(/"/g, '&quot;')}, ${index+1})">${cs.name}</div>
</div>
</td>
<td>${cs.errors}</td>
<td><span class="status-badge ${status.class}">${status.text}</span></td>
</tr>
`;
}).join('');
document.getElementById('csTableBody').innerHTML = tableHtml;

// Render chart distribusi kesalahan
renderErrorDistributionChart(sortedData);
}

// Fungsi untuk merender chart distribusi kesalahan
function renderErrorDistributionChart(data) {
const ctx = document.getElementById('errorDistributionChart').getContext('2d');

// Hancurkan chart sebelumnya jika ada
if (errorDistributionChart) {
errorDistributionChart.destroy();
}

// Siapkan data untuk chart
const labels = data.map(cs => {
const names = cs.name.split(' ');
return names.length > 1 ? `${names[0]} ${names[1].charAt(0)}.` : names[0];
});
const errors = data.map(cs => cs.errors);
const backgroundColors = data.map(cs => {
const status = getStatus(cs.errors);
if (status.class === 'status-good') return 'rgba(29, 209, 161, 0.7)';
if (status.class === 'status-warning') return 'rgba(254, 202, 87, 0.7)';
return 'rgba(255, 107, 107, 0.7)';
});

// Buat chart baru
errorDistributionChart = new Chart(ctx, {
type: 'bar',
data: {
labels: labels,
datasets: [{
label: 'Jumlah Kesalahan',
data: errors,
backgroundColor: backgroundColors,
borderColor: 'rgba(106, 17, 203, 0.8)',
borderWidth: 1
}]
},
options: {
responsive: true,
maintainAspectRatio: false,
scales: {
y: {
beginAtZero: true,
title: {
display: true,
text: 'Jumlah Kesalahan'
}
},
x: {
ticks: {
maxRotation: 45,
minRotation: 45
}
}
},
plugins: {
legend: {
display: false
},
tooltip: {
callbacks: {
label: function(context) {
return `Kesalahan: ${context.raw}`;
},
afterLabel: function(context) {
const cs = data[context.dataIndex];
const status = getStatus(cs.errors);
return `Status: ${status.text}`;
}
}
}
}
}
});
}

// Fungsi untuk memulai auto-update
function startAutoUpdate() {
// Hapus interval sebelumnya jika ada
if (autoUpdateInterval) {
clearInterval(autoUpdateInterval);
}
// Set interval untuk auto-update setiap 2 menit
autoUpdateInterval = setInterval(fetchDataFromSheet, 120000);
// Tampilkan indikator auto-update
document.getElementById('autoUpdateIndicator').style.display = 'flex';
}

// Fungsi untuk menghentikan auto-update
function stopAutoUpdate() {
if (autoUpdateInterval) {
clearInterval(autoUpdateInterval);
autoUpdateInterval = null;
}
// Sembunyikan indikator auto-update
document.getElementById('autoUpdateIndicator').style.display = 'none';
}

// Fungsi untuk parsing CSV yang lebih andal
function parseCSV(csv) {
const rows = csv.split(/\r?\n/).filter(row => row.trim() !== '');
if (rows.length === 0) return { headers: [], data: [] };

const headers = rows[0].split(',').map(header => header.trim().replace(/^"|"$/g, ''));
const data = [];

for (let i = 1; i < rows.length; i++) {
const row = rows[i];
const values = [];
let current = '';
let inQuote = false;

for (let j = 0; j < row.length; j++) {
if (row[j] === '"' && (j === 0 || row[j-1] !== '\\')) {
inQuote = !inQuote;
} else if (row[j] === ',' && !inQuote) {
values.push(current);
current = '';
} else {
current += row[j];
}
}
values.push(current);

// Hapus tanda kutip di awal dan akhir jika ada
const cleanValues = values.map(value => value.trim().replace(/^"|"$/g, ''));
data.push(cleanValues);
}

return { headers, data };
}

// Fungsi untuk memfilter tabel
function filterTable() {
const searchText = document.getElementById('searchInput').value.toLowerCase();
const statusFilter = document.getElementById('statusFilter').value;
const rows = document.querySelectorAll('#csTableBody tr');

rows.forEach(row => {
const name = row.querySelector('.cs-name-clickable').textContent.toLowerCase();
const status = row.querySelector('.status-badge').classList.contains('status-good') ? 'good' :
row.querySelector('.status-badge').classList.contains('status-warning') ? 'warning' : 'danger';

const nameMatch = name.includes(searchText);
const statusMatch = statusFilter === 'all' || status === statusFilter;

row.style.display = (nameMatch && statusMatch) ? '' : 'none';
});
}

// Event listener saat halaman dimuat
document.addEventListener('DOMContentLoaded', function() {
// Muat data pertama kali
fetchDataFromSheet();
// Mulai auto-update
startAutoUpdate();

// Event listener untuk tombol refresh
document.getElementById('refreshBtn').addEventListener('click', function() {
fetchDataFromSheet();
});

// Event listener untuk pencarian dan filter
document.getElementById('searchInput').addEventListener('input', filterTable);
document.getElementById('statusFilter').addEventListener('change', filterTable);

// Inisialisasi tab Bootstrap
const triggerTabList = [].slice.call(document.querySelectorAll('#dashboardTabs button'));
triggerTabList.forEach(function (triggerEl) {
new bootstrap.Tab(triggerEl);
});
});

// Handle visibilitas halaman untuk mengoptimalkan auto-update
document.addEventListener('visibilitychange', function() {
if (document.hidden) {
// Hentikan auto-update ketika tab tidak aktif
stopAutoUpdate();
} else {
// Lanjutkan auto-update ketika tab aktif kembali
startAutoUpdate();
// Perbarui data
fetchDataFromSheet();
}
});
</script>
</body>
</html>
